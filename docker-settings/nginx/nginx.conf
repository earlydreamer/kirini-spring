worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile        on;

    # 원본 IP 표시 설정 
    set_real_ip_from 127.0.0.1;
    set_real_ip_from 172.16.0.0/12;
    set_real_ip_from 10.0.0.0/8;
    set_real_ip_from 192.168.0.0/16;

    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /var/log/nginx/access.log main;

    # 스캐너 차단 & 레이트리밋
    limit_req_zone $binary_remote_addr zone=antiscanner:10m rate=5r/s;

    server {
        listen 80;
        server_name kirini.info www.kirini.info;

        # 민감 파일/디렉토리 차단
        location ~ /\.(?!well-known) {
            return 403;
        }
        location ~* \.(env|ini|yml|yaml|toml|conf|cnf|json|lock|pem|key|crt|pfx|p12)$ {
            return 403;
        }
        location ~* \.(bak|old|orig|swp|swo|tmp|save|backup)$ {
            return 403;
        }
        location ~* ^/(\.git|\.svn|\.hg|\.bzr|CVS|node_modules|vendor)/ {
            return 403;
        }
        location ~* ^/(Dockerfile|docker-compose\.yml|Makefile|package\.json|package-lock\.json|composer\.(json|lock))$ {
            return 403;
        }

        # PHP/WordPress 경로 전면 차단
        location ~* \.php$ {
            limit_req zone=antiscanner burst=10 nodelay;
            return 403;
        }
        location ~* ^/(wp-admin|wp-includes|wp-content|wordpress|wp-json|xmlrpc\.php) {
            limit_req zone=antiscanner burst=10 nodelay;
            return 403;
        }
        location ~* (wso\.php|wshell\.php|shell\.php|vendor/phpunit|composer\.(json|lock)|\.phar$) {
            limit_req zone=antiscanner burst=10 nodelay;
            return 403;
        }

        # 인증 챌린지
        location /.well-known/acme-challenge/ {
            root /var/www/html;
            try_files $uri =404;
        }

        # 명시적 정적 경로
        location /css/             { root /usr/share/nginx/html; }
        location /js/              { root /usr/share/nginx/html; }
        location /img/             { root /usr/share/nginx/html; }
        location /view/            { root /usr/share/nginx/html; }
        location /keyboard_terms/  { root /usr/share/nginx/html; }
        location /components/      { root /usr/share/nginx/html; }
        location /pages/           { root /usr/share/nginx/html; }

        # 업로드 보안
        location ~ ^/uploads/?$ {
            return 403;
        }
        # 업로드 경로 정의
        location /uploads/ {
            alias /usr/share/nginx/uploads/;
            autoindex off;
        }

        # static 파일 우선 서빙 시도하고 없으면 8080으로 보낸다
        location ^~ /news {
            root /usr/share/nginx/html;
            try_files $uri $uri/ @news_api;
            error_page 405 = @news_api;
        }

        location ^~ /freeboard {
            root /usr/share/nginx/html;
            try_files $uri $uri/ @freeboard_api;
            error_page 405 = @freeboard_api;
        }

        location ^~ /guide {
            proxy_pass http://service1-tomcat:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location ^~ /chatboard {
            root /usr/share/nginx/html;
            try_files $uri $uri/ @chatboard_api;
            error_page 405 = @chatboard_api;
        }

        location @news_api {
            proxy_pass http://service1-tomcat:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location @freeboard_api {
            proxy_pass http://service1-tomcat:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location @chatboard_api {
            proxy_pass http://service1-tomcat:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # .do 요청은 항상 톰캣
        location ~ \.do$ {
            proxy_pass http://service1-tomcat:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 기본 라우팅 (SPA 대응)
        location / {
            root /usr/share/nginx/html;
            index pages/index.html;
            try_files $uri $uri/ /pages/index.html;
        }
    }
}
