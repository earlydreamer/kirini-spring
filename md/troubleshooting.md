# 트러블슈팅 기록

작성일: 2026-01-02

## 1. Docker Compose 자동 연결 문제

### 증상
- H2 인메모리 DB를 사용하도록 설정했는데 MySQL 관련 에러가 발생
- `Unknown table 'SEQUENCES' in information_schema` 에러

### 원인
- `spring-boot-docker-compose` 의존성이 프로젝트 루트의 `compose.yaml` 파일을 자동 감지
- H2 설정을 무시하고 MySQL 컨테이너로 연결 시도

### 해결
`application.properties`에 Docker Compose 자동 연결 비활성화 설정 추가:
```properties
spring.docker.compose.enabled=false
```

---

## 2. Hibernate 7.2 + MySQL AUTO_INCREMENT 호환성 문제

### 증상
```
Error executing DDL "create table freeboard (...integer generated by default as identity...)"
You have an error in your SQL syntax
```

### 원인
- Hibernate 7.2가 SQL 표준인 `GENERATED BY DEFAULT AS IDENTITY` 문법을 생성
- MySQL은 이 문법을 지원하지 않고 `AUTO_INCREMENT` 사용

### 시도한 해결 방법들
1. `columnDefinition = "INT AUTO_INCREMENT"` 추가 → H2와 호환성 문제 발생
2. `hibernate.id.db_structure_naming_strategy=legacy` 설정 → 효과 없음
3. `MySQL8Dialect` 사용 → 효과 없음

### 최종 해결
- 로컬 개발: H2 사용 (`ddl-auto=create-drop`)
- MySQL 환경: `ddl-auto=none` + 수동 스키마 파일(`schema-mysql.sql`) 사용

---

## 3. H2 예약어 문제 (`user` 테이블)

### 증상
```
Syntax error in SQL statement "drop table if exists [*]user cascade"
expected "identifier"
```

### 원인
- `user`는 H2 데이터베이스에서 **예약어**
- Hibernate가 DDL 생성 시 따옴표 없이 테이블명 사용

### 해결
테이블명을 `user`에서 `account`로 변경:

| 기존 | 변경 후 |
|------|---------|
| `user` | `account` |
| `user_uid` | `account_uid` |
| `user_id` | `account_id` |
| `user_password` | `account_password` |
| `user_name` | `account_name` |
| `user_email` | `account_email` |
| `user_introduce` | `account_introduce` |
| `user_authority` | `account_authority` |
| `user_point` | `account_point` |
| `user_icon` | `account_icon` |
| `user_status` | `account_status` |
| `user_penalty` | `account_penalty` |
| `scrap_user_uid` | `scrap_account_uid` |

### 수정된 파일
- `User.java` - 테이블명 및 모든 컬럼명 변경
- `Freeboard.java` - 인덱스 및 외래키 변경
- `FreeboardComment.java` - 외래키 변경
- `KeyboardScore.java` - 외래키 변경
- `UserPenalty.java` - 테이블명 및 외래키 변경
- `Scrap.java` - 외래키 변경
- `schema-mysql.sql` - MySQL 스키마 파일 업데이트

---

## 4. 최종 환경 설정 요약

### 프로파일별 데이터베이스 설정

| 프로파일 | DB | Dialect | ddl-auto | Docker Compose |
|---------|-----|---------|----------|----------------|
| 기본 (로컬) | H2 | H2Dialect | create-drop | 비활성화 |
| devtest | MySQL 8.4.4 | MySQLDialect | update | 활성화 |
| prod | MySQL 8.4.4 | MySQLDialect | validate | - |

### 실행 명령어

```bash
# 로컬 개발 (H2)
.\gradlew.bat bootRun

# 개발서버 (MySQL)
.\gradlew.bat bootRun --args="--spring.profiles.active=devtest"

# 운영서버 (MySQL)
.\gradlew.bat bootRun --args="--spring.profiles.active=prod"
```

---

## 5. 참고 사항

### Hibernate 7.2 + MySQL 사용 시 주의점
1. `GenerationType.IDENTITY`는 H2에서는 정상 동작하지만, MySQL DDL 생성 시 문제 발생 가능
2. MySQL 환경에서는 `ddl-auto=none` + 수동 스키마 관리 권장
3. 또는 Flyway/Liquibase 같은 마이그레이션 도구 사용 권장

### H2 예약어 목록 (주의 필요)
- `USER`, `ORDER`, `GROUP`, `KEY`, `INDEX`, `CONSTRAINT` 등
- 예약어를 테이블/컬럼명으로 사용 시 따옴표로 감싸거나 다른 이름 사용

